<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}NetScan{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    
    <!-- Font Awesome -->
    <link href="{{ url_for('static', filename='css/fontawesome-local.css') }}" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.1/dist/cdn.min.js"></script>
    
    <!-- Custom styles -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    <script>
        tailwind.config = {
            daisyui: {
                themes: ["light", "dark", "corporate", "dracula"]
            }
        }
    </script>
</head>
<body class="min-h-screen bg-base-100" x-data="appData()">
    {% if current_user.is_authenticated %}
    <!-- Sidebar Layout -->
    <div class="drawer lg:drawer-open">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        
        <!-- Page content -->
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-base-300 shadow-sm">
                <div class="flex-none lg:hidden">
                    <label for="drawer-toggle" class="btn btn-square btn-ghost">
                        <i class="fas fa-bars"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-ghost normal-case text-xl">
                        <i class="fas fa-network-wired mr-2"></i>NetScan
                    </a>
                </div>
                <div class="flex-none gap-2">
                    <!-- Theme toggle -->
                    <label class="swap swap-rotate btn btn-ghost btn-circle">
                        <input type="checkbox" @change="toggleTheme()" x-model="isDarkMode" />
                        <i class="fas fa-sun swap-on fill-current w-4 h-4"></i>
                        <i class="fas fa-moon swap-off fill-current w-4 h-4"></i>
                    </label>
                    
                    <!-- User dropdown -->
                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-circle avatar">
                            <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
                                <i class="fas fa-user"></i>
                            </div>
                        </label>
                        <ul tabindex="0" class="mt-3 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                            <li class="menu-title">
                                <span>{{ current_user.username }}</span>
                                <span class="badge badge-sm badge-{{ 'error' if current_user.role.value == 'admin' else 'primary' if current_user.role.value == 'editor' else 'secondary' }}">
                                    {{ current_user.role.value.title() }}
                                </span>
                            </li>
                            <li>
                                <a href="{{ url_for('auth.change_password') }}">
                                    <i class="fas fa-key"></i> Change Password
                                </a>
                            </li>
                            {% if current_user.can_admin() %}
                            <li>
                                <a href="{{ url_for('admin.users') }}">
                                    <i class="fas fa-users"></i> Users
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a href="{{ url_for('auth.logout') }}">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Main content -->
            <main class="flex-1 p-6">
                <!-- Toast notifications -->
                <div id="toast-container" class="toast toast-top toast-end z-50">
                    <!-- Toasts will be dynamically added here -->
                </div>
                
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }} mb-4">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                                <span>{{ message }}</span>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% block content %}{% endblock %}
            </main>
        </div>
        
        <!-- Sidebar -->
        <div class="drawer-side">
            <label for="drawer-toggle" class="drawer-overlay"></label>
            <aside class="w-64 min-h-full bg-base-200">
                <div class="p-4">
                    <h2 class="text-lg font-semibold mb-4">Navigation</h2>
                    <ul class="menu menu-vertical">
                        <li>
                            <a href="{{ url_for('dashboard') }}" class="{{ 'active' if request.endpoint == 'dashboard' }}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="{{ url_for('devices') }}" class="{{ 'active' if request.endpoint == 'devices' }}">
                                <i class="fas fa-desktop"></i> Devices
                            </a>
                        </li>
                        <li>
                            <a href="{{ url_for('people') }}" class="{{ 'active' if request.endpoint == 'people' }}">
                                <i class="fas fa-users"></i> People
                            </a>
                        </li>
                        <li>
                            <a href="{{ url_for('oui_lookup') }}" class="{{ 'active' if request.endpoint == 'oui_lookup' }}">
                                <i class="fas fa-search"></i> OUI Lookup
                            </a>
                        </li>
                        <li>
                            <a href="{{ url_for('stats') }}" class="{{ 'active' if request.endpoint == 'stats' }}">
                                <i class="fas fa-chart-bar"></i> Statistics
                            </a>
                        </li>
                        <li>
                            <a href="{{ url_for('settings') }}" class="{{ 'active' if request.endpoint == 'settings' }}">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
    {% else %}
    <!-- Login page layout -->
    <div class="min-h-screen flex items-center justify-center bg-base-200">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }} mb-4">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    {% endif %}

    <!-- Enhanced App Scripts -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Alpine.js app data
        function appData() {
            return {
                isDarkMode: localStorage.getItem('darkMode') === 'true',
                
                init() {
                    this.setTheme();
                    this.initializeGitHubAvatars();
                    this.setupEventListeners();
                },
                
                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    this.setTheme();
                    localStorage.setItem('darkMode', this.isDarkMode);
                },
                
                setTheme() {
                    document.documentElement.setAttribute('data-theme', this.isDarkMode ? 'dark' : 'light');
                },
                
                initializeGitHubAvatars() {
                    if (typeof initializeGitHubAvatars === 'function') {
                        initializeGitHubAvatars();
                    }
                },
                
                setupEventListeners() {
                    // Setup Server-Sent Events for real-time updates
                    this.setupSSE();
                }
            }
        }
        
        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg`;
            toast.innerHTML = `
                <div>
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                                      type === 'success' ? 'check-circle' : 
                                      type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <div class="flex-none">
                    <button class="btn btn-sm btn-ghost" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, duration);
        }
        
        // Enhanced scan functionality with progress
        function startEnhancedScan() {
            const button = event.target;
            const originalContent = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Scanning...';
            
            showToast('Network scan started', 'info');
            
            // Start scan with progress tracking
            fetch('/api/scan/start', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Scan completed! Found ${data.devices_found} devices.`, 'success');
                    // Refresh page or update content via HTMX
                    if (typeof htmx !== 'undefined') {
                        htmx.trigger(document.body, 'scan-completed');
                    } else {
                        location.reload();
                    }
                } else {
                    showToast(`Scan failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showToast(`Error: ${error}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme from Alpine.js
            if (window.Alpine && window.Alpine.version) {
                // Alpine.js will handle initialization
            } else {
                // Fallback for when Alpine.js is not loaded
                const darkMode = localStorage.getItem('darkMode') === 'true';
                document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>